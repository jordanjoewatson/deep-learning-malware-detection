#!/bin/bash
# note that this file will make changes to the file system.
# also if using a large dataset this could take a long time to run
# it is highly advised to do this manually as it will be 
# easier to see what each file is doing

# set datadir to the directory that will hold the data, e.g. /home/user/dir/
# projectpath should be the path to the project root
# infection file name is the file used to infect the malware for adversarial variants
# this file must exist in the goodware dataset
datadir="/home/user/example/"
projectpath="/home/user/malwaredetection/"
infectionFilename="user.exe"

# Before running the script, the following commands must be done manually
# create three directories as followed
# mkdir ${datadir}/goodwareFiles
# mkdir ${datadir}/malwareFiles
# now copy the goodware and malware files for your own dataset into these directories
# copy the malware directory into a new directory
# cp -R ${datadir}/malwareFiles ${datadir}/adversarialFiles

echo "[*] Creating Adversarial Variants by injecting ${infectionFilename}"
python ${projectpath}src/adversarial-variants/sectionInjection.py ${datadir}goodwareFiles/${infectionFilename} ${datadir}adversarialFiles/

echo "[*] Creating section directories"
mkdir ${datadir}goodwareSectionFiles
mkdir ${datadir}malwareSectionFiles
mkdir ${datadir}adversarialSectionFiles

echo "[*] Splitting goodware into section files"
python3 ${projectpath}src/data-preparation/fileSplitter.py -s ${datadir}goodwareFiles/ -d ${datadir}goodwareSectionFiles/
echo "[*] Splitting malware into section files"
python3 ${projectpath}src/data-preparation/fileSplitter.py -s ${datadir}malwareFiles/ -d ${datadir}malwareSectionFiles/
echo "[*] Splitting adversarial files into section files"
python3 ${projectpath}src/data-preparation/fileSplitter.py -s ${datadir}adversarialFiles/ -d ${datadir}adversarialSectionFiles/

echo "[*] Creating image directories"
mkdir ${datadir}goodwareSectionImages
mkdir ${datadir}malwareSectionImages
mkdir ${datadir}adversarialSectionImages

echo "[*] Converting goodware files to images"
python3 ${projectpath}src/data-preparation/sectionImageWriter.py -f ${datadir}goodwareSectionFiles/ -g ${datadir}goodwareSectionImages/ -r 32 2>/dev/null

echo "[*] Converting malware files to images"
python3 ${projectpath}src/data-preparation/sectionImageWriter.py -f ${datadir}malwareSectionFiles/ -g ${datadir}malwareSectionImages/ -r 32 2>/dev/null

echo "[*] Converting adversarial variants to images"
python3 ${projectpath}src/data-preparation/sectionImageWriter.py -f ${datadir}adversarialSectionFiles/ -g ${datadir}adversarialSectionImages/ -r 32 2>/dev/null

echo "[*] Finished"
